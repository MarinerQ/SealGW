# Sky Localisation Method for the SPIIR Pipeline by Qian Hu

## Setup

First, we generate a healpix skygrid with a specified resolution with the 
`sky_grids/generate_skygrids.py` script. This script generates 2 dimensional arrays 
corresponding to right ascension and declination for each of the pixels in the sky 
grid, at resolutions from $2^4$ pixels to $2^10$ pixels increasing in orders of 2.

The output of this script is a collection of .txt files stored in `sky_grids/` that 
is used as input to the coherent skymap localisation script called by the executable 
generated by calling `make`.

## Script Structure

`statistic.coherent_analysis` 

In this part, we calculate the PDF skymap and do some statistic tests. This part needs to use the output of snr_generator. If you don't change the snr_generator, then the default event time is on 1234568146.

    ndata           : Can not be larger than the number of data you have.
    Ndet            : Don't change this!
    ntime           : The number of sample point between start_time and end_time. 
    nlevel          : the maximum reselution of skymap, i.e. 2**nlevel.
    nthread         : The number of thread you want.
    save_skymap     : the option for you to save the skymap.
    save_statistic  : the option for you to save the statistic result.

1. `coherent.load_healpix_skygrids_from_file`:
  
    First we load the 2-dimensional right ascension and declination sky grids generated 
    by `sky_grids/generate_skygrids.py` at all resolutions from $2^4$ pixels to $2^{10}$ 
    pixels, by copying them into memory as arays. 

    - `coherent.create_healpix_skygrids_from_file`

2. `coherent.readsnr2time_series`

    Loads the complex SNR time series from the file and reads it into a timeseries 
    array, for `Ndet` detectors.

3. `coherent.create_data_streams`

    This function constructs a timeseries array and a datasream array as two defined
    structs: `time_series` and `data_streams`.
    
    - `time_series` is a struct with the number of elements in the array (`npoint`), 
        the start time of the time series (`start_time`), the time difference between 
        each element (`delta_t`), and the complex SNR values themselves (`complex`)
    - `data_streams` is a collection of multiple (`Nstream`) `time_series` arrays, 
        where `Nstream = Ndet`.

4. `coherent.coh_skymap_multiRes_qian`

    This is the main function that generates the skymap as an array of probabilities.

    - `coherent.create_healpix_skygrids_from_file`
    - `coherent.coherent_skymap_qian`
    - `coherent.rank_OneOfFour2`



5. `statistic.localization_point_healpix`

    Outputs the index of the nearest point on the sky grid for a given sky direction.

    - `coherent.create_healpix_skygrids_from_file`
    
6. `statistic.max_coherent_snr`

    Finds the point in the localisation skymap with the highest coherent SNR. (?)

7. `statistic.exp_cumulative_skyarea`

    This function is calculated twice to estimate hte 50% credible interval and the 90% 
    credible interval in $deg^2$.

8. `statistic.exp_cumulative_search_area`

    - `statistic.healpix_nearby_interpolate`
      - `coherent.create_healpix_skygrids_from_file`
    - `statistic.distance_2D_sphere`


9. `statistic.distance_2D_sphere`



10. `statistic.exp_cumulative_percentage`


    - `statistic.healpix_nearby_interpolate`


11. `coherent.free_data_streams`


## TODO

### Coherent Analysis

    - Enable input arguments for the `statistic.coherent_analysis` function.

### Data 

    - Review necessity of using text files and perhaps implement a better alternative.
    - Refactor hard-coded specifications to load `nside` sky grids in the function 
        `coherent.load_healpix_skygrids_from_file`.
    - Provide horizon distance values and refactor reading of this data artifact.

### Localisation Algorithm

  - Implement adaptive healpix methods.
  - Implement a version of the skymap localisation compatible for arbitrary detectors, 
        rather than only `Ndet=3`, ensuring proper memory management.